<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Study</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* === PALETTE === */
            --bg-page: #F9FAFB;
            --bg-card: #FFFFFF;
            --text-main: #111827;
            --text-secondary: #6B7280;
            
            --color-long: #10B981;  /* Emerald */
            --color-short: #EF4444; /* Red */
            --color-tech: #4F46E5;  /* Indigo */
            --color-ui: #E5E7EB;    
            
            --border-radius: 12px;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: var(--bg-page); 
            color: var(--text-main); 
            margin: 0; 
            padding: 40px 20px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            /* DISABLE TEXT SELECTION */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }
        
        textarea { user-select: text; -webkit-user-select: text; cursor: text; }
        
        #app { 
            background: var(--bg-card); 
            width: 100%; 
            max-width: 800px; 
            padding: 48px; 
            border-radius: 16px; 
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        h1 { font-size: 28px; font-weight: 800; margin-bottom: 24px; letter-spacing: -0.02em; color: #111; }
        h2 { font-size: 18px; font-weight: 700; margin: 0 0 16px 0; color: #333; }
        p, li { line-height: 1.6; color: var(--text-secondary); font-size: 15px; margin-bottom: 12px; }
        b, strong { color: var(--text-main); font-weight: 700; }
        
        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 16px 24px; background: #FFFFFF; border-radius: 12px; 
            border: 1px solid var(--color-ui); margin-bottom: 32px;
        }
        .header-item { font-size: 12px; font-weight: 700; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.05em; }
        .header-val { color: var(--text-main); font-weight: 800; font-size: 18px; margin-left: 8px; }
        .timer { 
            font-family: 'Inter', monospace; color: var(--color-short); font-weight: 700; 
            background: #FEF2F2; padding: 6px 12px; border-radius: 8px; font-variant-numeric: tabular-nums;
        }
        
        /* BALANCE */
        .balance-container { 
            text-align: center; margin: 32px 0; padding: 32px; 
            background: #F9FAFB; border-radius: 16px; border: 1px solid var(--color-ui); 
        }
        .balance-label { font-size: 13px; font-weight: 600; color: #6B7280; text-transform: uppercase; letter-spacing: 1px; }
        .balance-val { font-size: 56px; font-weight: 800; color: var(--text-main); margin: 12px 0; letter-spacing: -1.5px; }
        .pnl-badge { display: inline-block; padding: 8px 16px; border-radius: 100px; font-weight: 700; font-size: 16px; color: white; }
        
        /* CHART */
        .chart-container { border: 1px solid var(--color-ui); border-radius: 12px; overflow: hidden; margin-bottom: 24px; pointer-events: none; }
        .chart-img { width: 100%; height: auto; display: block; }
        
        /* ALGO BOX */
        .algo-box {
            background: #FFFFFF; padding: 24px; border-radius: 12px; margin: 24px 0;
            border: 1px solid var(--color-ui); border-left: 5px solid var(--color-tech);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .algo-title {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--color-tech);
            font-weight: 800; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
        }
        .algo-title::before { content: "‚óè"; font-size: 10px; }
        .algo-text { font-size: 17px; font-weight: 600; line-height: 1.5; color: var(--text-main); }

        /* INFO & PRACTICE */
        .info-blue { background: #EFF6FF; border: 1px solid #DBEAFE; color: #1E40AF; padding: 20px; border-radius: 12px; margin-bottom: 24px; }
        .practice-box {
            background: #EFF6FF; border: 1px solid #BFDBFE; color: #1E40AF;
            padding: 16px; border-radius: 12px; margin: 24px 0;
            font-weight: 600; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* SLIDERS */
        .slider-group { margin: 40px 0; position: relative; }
        .slider-label { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 25px; display: block; }
        
        .range-wrapper { position: relative; width: 100%; height: 30px; }

        input[type=range] { 
            -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; position: absolute; top: 10px; left: 0; z-index: 2;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; background: #E5E7EB; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #FFFFFF; border: 2px solid var(--color-tech); margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); }

        /* FLOATING BUBBLE */
        .bubble {
            position: absolute; top: -35px; left: 0; transform: translateX(-50%);
            background: var(--color-tech); color: white; padding: 4px 8px; border-radius: 6px;
            font-size: 14px; font-weight: 700; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            pointer-events: none; z-index: 3; min-width: 30px; text-align: center;
        }
        .bubble::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            border-width: 4px 4px 0; border-style: solid; border-color: var(--color-tech) transparent transparent transparent;
        }

        .range-labels { display: flex; justify-content: space-between; font-size: 12px; font-weight: 500; color: #9CA3AF; margin-top: 5px; }

        /* BUTTONS */
        .btn-row { display: flex; gap: 16px; margin-top: 24px; }
        button { 
            flex: 1; padding: 18px; border: none; border-radius: 12px; 
            font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 700; 
            cursor: pointer; transition: all 0.2s; color: white; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        button:hover { opacity: 0.95; transform: translateY(-2px); }
        
        .btn-long { background-color: var(--color-long); }
        .btn-short { background-color: var(--color-short); }
        .btn-neutral { background-color: var(--color-tech); }
        .btn-gray { background-color: #6B7280; } 
        .btn-ghost { background: #F3F4F6; color: var(--text-main); box-shadow: none; border: 1px solid var(--color-ui); }
        .btn-ghost:hover { background: #E5E7EB; }

        .debrief-box { background: #EFF6FF; border: 1px solid #BFDBFE; border-radius: 12px; padding: 24px; margin: 32px 0; text-align: left; }
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); backdrop-filter: blur(4px); z-index:999; text-align:center; padding-top: 20%; font-size: 20px; font-weight: 700; color: var(--color-tech); }
    </style>
</head>
<body>

<div id="loader">Saving Experiment Data...<br>Please do not close.</div>
<div id="app"></div>

<script>
    // ======================================================
    // üî• GOOGLE SCRIPT URL
    // ======================================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyk0Bq3QLmNW7ODrPlgQdpZBbkJmbiJ8Plh5YEGsOKbPM-lxzj0J4BAepZPArR0f7RJ/exec"; 
    // ======================================================

    const MAX_ROUNDS = 15;
    const urlParams = new URLSearchParams(window.location.search);
    const PID = urlParams.get('PROLIFIC_PID') || 'guest_' + Math.random().toString(36).substr(2, 5);

    const SCENARIOS = {
        1: {ticker: "NVDA", outcome: "Long", change_pct: 0.87, text: "Market data confirms a stable upward trend. Probability of growth: 85%"},
        2: {ticker: "MSFT", outcome: "Long", change_pct: 3.53, text: "Statistical momentum indicators suggest a 91% probability of continued growth. Recommendation: LONG"},
        3: {ticker: "BTC", outcome: "Short", change_pct: 1.89, text: "Standard Chartered analysts report that institutional whales are buying this dip. Massive recovery expected. Recommendation: LONG"},
        4: {ticker: "TSLA", outcome: "Long", change_pct: 0.57, text: "Traders are rapidly accumulating positions as sentiment turns bullish. Don't miss the trend. Recommendation: LONG"},
        5: {ticker: "AMZN", outcome: "Long", change_pct: 2.71, text: "RSI levels indicate an extreme overbought condition. Statistical reversal is expected within the next minutes. Recommendation: SHORT"},
        6: {ticker: "XRP", outcome: "Short", change_pct: 4.69, text: "Market anomaly detected. Asset is extremely oversold. Predictive models show a 94% probability of an immediate rebound. Recommendation: LONG"},
        7: {ticker: "Gold", outcome: "Short", change_pct: 1.00, text: "Central banks report record-breaking accumulation of this asset. Leading experts identify this pullback as a 'Strategic Entry' point. Recommendation: LONG"},
        8: {ticker: "ETH", outcome: "Short", change_pct: 3.11, text: "Retail traders are panic selling, but smart money is aggressively 'Buying the Dip'. Don't be left behind. Recommendation: LONG"},
        9: {ticker: "Nat Gas", outcome: "Long", change_pct: 5.12, text: "Thousands of traders are jumping into long positions right now. Follow the smart crowd ‚Äî don't miss this rally. Recommendation: LONG"},
        10: {ticker: "ADA", outcome: "Short", change_pct: 1.71, text: "Top-tier investment banks maintain a 'Strong Buy' rating for this asset. Growth target remains unchanged. Recommendation: LONG"},
        11: {ticker: "Brent Oil", outcome: "Short", change_pct: 2.76, text: "Retail traders are exiting positions to cut losses. Join the market momentum. Recommendation: SHORT"},
        12: {ticker: "AAPL", outcome: "Short", change_pct: 0.09, text: "To verify you are reading this, do not select any prediction. Instead, click the 'SKIP' button to skip this round and continue the experiment."},
        13: {ticker: "SOL", outcome: "Short", change_pct: 3.18, text: "Price has hit a major Fibonacci support level. Recommendation: LONG"},
        14: {ticker: "Silver", outcome: "Short", change_pct: 3.64, text: "Major central banks have paused their accumulation phase. Leading institutional analysts confirm a 'Deep Correction' trend. Recommendation: SHORT"},
        15: {ticker: "Copper", outcome: "Short", change_pct: 3.28, text: "Whales are buying the dip! Retail panic is over, and the community is shifting to a massive 'Long' sentiment. Follow the leaders. Recommendation: LONG"}
    };

    // State
    let state = { 
        step: 'consent', 
        round: 1, 
        balance: 1000.0, 
        history: [], 
        roundData: {}, 
        timer: null, 
        timeLeft: 30,
        surveyAnswers: {} 
    };

    // Helper functions
    function updateBubble(sliderId, bubbleId, prefix = "", suffix = "") {
        const slider = document.getElementById(sliderId);
        const bubble = document.getElementById(bubbleId);
        if(!slider || !bubble) return;
        const val = slider.value;
        const min = slider.min ? slider.min : 0;
        const max = slider.max ? slider.max : 100;
        const newVal = Number(((val - min) * 100) / (max - min));
        bubble.innerHTML = `${prefix}${val}${suffix}`;
        bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
    }

    function render() {
        const app = document.getElementById('app');
        app.innerHTML = '';

        // --- 1. CONSENT ---
        if (state.step === 'consent') {
            app.innerHTML = `
                <h1>Trading & Algorithmic Systems Study</h1>
                <div class="info-blue">
                    <p style="margin:0; color:#1E40AF; font-weight:500;">Welcome. You are invited to participate in a behavioral finance study investigating how traders interact with algorithmic decision-support systems.</p>
                </div>
                
                <p>You will act as a trader managing a virtual portfolio in volatile markets.</p>
                <p>You will complete <strong>15 trading rounds</strong> (approx. 10-12 minutes).</p>
                <p>In each round, you will analyze a chart and make a prediction (Long/Short).</p>
                <p>You will receive real-time data from an <strong>Algorithmic Co-Pilot</strong>.</p>
                <p>Your goal is to maximize your virtual capital based on market accuracy.</p>
                
                <p style="margin-top:20px;"><strong>Privacy Notice:</strong> No personally identifiable information (PII) will be stored or shared. Your data is completely anonymous.</p>
                <p style="font-size:13px; color:#9CA3AF;"><em>Note: Your compensation is fixed based on the Prolific rate. The virtual balance ($1,000) is a gamified metric for research purposes.</em></p>
                
                <div style="margin-top:40px; font-size:12px; color:#9CA3AF; border-top:1px solid #E5E7EB; padding-top:20px;">
                    <p><strong>Researcher Contact:</strong> kovalch.anna@gmail.com (Researcher)</p>
                </div>

                <hr style="margin:20px 0; border:0; border-top:1px solid var(--color-ui);">
                <button class="btn-neutral" style="width:100%" onclick="state.step='instructions'; render()">I Accept & Start</button>
            `;
        }
        
        // --- 2. INSTRUCTIONS ---
        else if (state.step === 'instructions') {
            app.innerHTML = `
                <h1>Instructions</h1>
                <p>Complete the following steps for each of the 15 sessions:</p>
                
                <ol style="line-height:2; margin-bottom:32px; padding-left: 24px;">
                    <li>Look at the price chart provided.</li>
                    <li>Choose your investment amount ($) and direction.</li>
                    <li>Review the suggestion from the Algorithm.</li>
                    <li>Confirm your final trade or switch based on the advice. You will see the result (+24h) immediately.</li>
                    <li>After seeing the result, briefly rate your Emotion and Responsibility.</li>
                </ol>
                
                <hr style="margin:32px 0; border:0; border-top:1px solid var(--color-ui);">
                <p>Before beginning the trading simulation, please answer a brief survey.</p>
                <button class="btn-neutral" style="width:100%" onclick="state.step='pre_survey'; render()">Next: Pre-Study Survey ‚Üí</button>
            `;
        }

        // --- 3. PRE-STUDY SURVEY (4 QUESTIONS) ---
        else if (state.step === 'pre_survey') {
            app.innerHTML = `
                <h1>Baseline Trading Profile</h1>
                <p style="margin-bottom:40px; font-size:16px;">Before we begin, please reflect on your <strong>previous experience</strong> with financial markets and automated tools.</p>
                
                <div class="slider-group">
                    <label class="slider-label">I have used trading signals, technical indicators (e.g., RSI, MACD), or robo-advisors in the past.</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-f1">4</div>
                        <input type="range" id="f1" min="1" max="7" value="4" oninput="updateBubble('f1', 'b-f1')">
                    </div>
                    <div class="range-labels"><span>1 (Never)</span><span>7 (Frequently)</span></div>
                </div>

                <div class="slider-group">
                    <label class="slider-label">I believe that algorithms are generally more objective and accurate than human traders.</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-f2">4</div>
                        <input type="range" id="f2" min="1" max="7" value="4" oninput="updateBubble('f2', 'b-f2')">
                    </div>
                    <div class="range-labels"><span>1 (Strongly Disagree)</span><span>7 (Strongly Agree)</span></div>
                </div>

                <div class="slider-group">
                    <label class="slider-label">In financial decisions, I prefer to follow clear data signals rather than my gut feeling.</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-f3">4</div>
                        <input type="range" id="f3" min="1" max="7" value="4" oninput="updateBubble('f3', 'b-f3')">
                    </div>
                    <div class="range-labels"><span>1 (Prefer Intuition)</span><span>7 (Prefer Data)</span></div>
                </div>

                <div class="slider-group">
                    <label class="slider-label">If a proven trading bot was available to me, I would use it for real investments.</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-f4">4</div>
                        <input type="range" id="f4" min="1" max="7" value="4" oninput="updateBubble('f4', 'b-f4')">
                    </div>
                    <div class="range-labels"><span>1 (Definitely Not)</span><span>7 (Definitely Yes)</span></div>
                </div>
                
                <div class="btn-row"><button class="btn-neutral" onclick="savePreSurveyAndStart()">Submit & Start Trading</button></div>
            `;
            setTimeout(() => {
                updateBubble('f1', 'b-f1'); updateBubble('f2', 'b-f2');
                updateBubble('f3', 'b-f3'); updateBubble('f4', 'b-f4');
            }, 50);
        }

        // --- 4. PHASE 1: INITIAL (GAME ROUND START) ---
        else if (state.step === 'initial') {
            if (state.round===1 && state.balance!==1000) state.balance=1000;
            app.innerHTML = `
                <div class="header">
                    <div style="display:flex; align-items:center">
                        <span class="header-item">ROUND</span>
                        <span class="header-val">${state.round} / ${MAX_ROUNDS}</span>
                    </div>
                    <div style="display:flex; align-items:center">
                         <span class="header-item">BALANCE</span>
                         <span class="header-val" style="color:var(--color-long)">$${state.balance.toFixed(0)}</span>
                    </div>
                    <span id="timer" class="timer">30s</span>
                </div>
                ${state.round===1 ? '<div style="text-align:center; color:var(--color-tech); font-weight:700; margin-bottom:24px; font-size:13px; letter-spacing:1px; text-transform:uppercase;">‚ÑπÔ∏è Practice Mode</div>' : ''}
                
                <div class="chart-container"><img src="assets/${state.round}_start.png" class="chart-img" onerror="this.src='assets/${state.round}_start.PNG'"></div>
                
                <h2>1. Initial Market Assessment</h2>
                
                <div class="slider-group">
                    <label class="slider-label">Investment Amount</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-wager">$100</div>
                        <input type="range" id="wager" min="10" max="1000" value="100" step="10" oninput="updateBubble('wager', 'b-wager', '$', '')">
                    </div>
                    <div class="range-labels"><span>$10</span><span>$1000</span></div>
                </div>
                
                <div class="btn-row">
                    <button class="btn-long" onclick="commit('Long')">üìà Long</button>
                    <button class="btn-short" onclick="commit('Short')">üìâ Short</button>
                </div>
            `;
            updateBubble('wager', 'b-wager', '$', '');
            startTimer();
        }

        // --- 5. PHASE 2: DECISION ---
        else if (state.step === 'decision') {
            const sc = SCENARIOS[state.round];
            const isTrap = state.round === 12;
            
            let btns = '';
            if (isTrap) {
                btns = `
                    <button class="btn-long" onclick="finalize('Long')">Long</button>
                    <button class="btn-short" onclick="finalize('Short')">Short</button>
                    <button class="btn-gray" onclick="finalize('SKIP')">Skip</button>
                `;
            } else {
                btns = `
                    <button class="btn-long" onclick="finalize('Long')">Long</button>
                    <button class="btn-short" onclick="finalize('Short')">Short</button>
                `;
            }
            
            app.innerHTML = `
                <div class="header" style="justify-content:center; border:none; margin-bottom:0; background:transparent; box-shadow:none;"><h2>Decision Phase</h2></div>
                <div class="chart-container" style="margin-bottom:20px; border-color:#eee;">
                    <img src="assets/${state.round}_start.png" class="chart-img" onerror="this.src='assets/${state.round}_start.PNG'" style="opacity:0.8;">
                </div>
                <div class="algo-box">
                    <div class="algo-title">‚óè ALGORITHMIC INSIGHT</div>
                    <div class="algo-text">${sc.text}</div>
                </div>
                
                <p style="text-align:center; margin-bottom:24px; font-size:16px;">
                    You currently have <b>$${state.roundData.initial_wager}</b> on <b>${state.roundData.initial_choice}</b>.<br>Do you want to change your decision?
                </p>
                
                <div class="slider-group">
                    <label class="slider-label">Final Investment</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-wager2"></div>
                        <input type="range" id="wager2" min="10" max="1000" value="${state.roundData.initial_wager}" step="10" oninput="updateBubble('wager2', 'b-wager2', '$', '')">
                    </div>
                    <div class="range-labels"><span>$10</span><span>$1000</span></div>
                </div>
                
                <div class="btn-row">${btns}</div>
            `;
            setTimeout(() => updateBubble('wager2', 'b-wager2', '$', ''), 50);
        }

        // --- 6. PHASE 3: RESULT ---
        else if (state.step === 'result') {
            const pnl = state.roundData.pnl;
            const isSkip = state.roundData.final_choice === 'SKIP';
            const badgeColor = isSkip ? '#9CA3AF' : (pnl>=0 ? 'var(--color-long)' : 'var(--color-short)');
            const txtBadge = isSkip ? 'Skipped' : (pnl>=0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`);
            
            let footer = state.round === 12 
                ? `<button class="btn-neutral" onclick="next()" style="width:100%">Next Round ‚Üí</button>`
                : `<div style="background:#F9FAFB; padding:32px; border-radius:16px; border:1px solid var(--color-ui); margin-top:40px;">
                     <h3 style="margin-top:0; font-size:18px; font-weight:700; text-align:center; margin-bottom:24px;">Outcome & Post-Trade Survey</h3>
                     
                     <div class="slider-group">
                        <label class="slider-label">To what extent do you feel regret regarding the outcome?</label>
                        <div class="range-wrapper">
                            <div class="bubble" id="b-q1">1</div>
                            <input type="range" id="q1" min="1" max="7" value="1" oninput="updateBubble('q1', 'b-q1', '', '')">
                        </div>
                        <div class="range-labels"><span>1 (Not at all)</span><span>7 (Very Strongly)</span></div>
                     </div>
                     
                     <div class="slider-group">
                        <label class="slider-label">Who is responsible for this trade's outcome?</label>
                        <div class="range-wrapper">
                            <div class="bubble" id="b-q2">50%</div>
                            <input type="range" id="q2" min="0" max="100" value="50" oninput="updateBubble('q2', 'b-q2', '', '%')">
                        </div>
                        <div class="range-labels"><span>0% (Algorithm)</span><span>100% (Me)</span></div>
                     </div>
                     
                     <div class="slider-group">
                        <label class="slider-label">How much did the algorithmic suggestion influence you?</label>
                        <div class="range-wrapper">
                            <div class="bubble" id="b-q3">0%</div>
                            <input type="range" id="q3" min="0" max="100" value="0" oninput="updateBubble('q3', 'b-q3', '', '%')">
                        </div>
                        <div class="range-labels"><span>0%</span><span>100%</span></div>
                     </div>
                     
                     <button class="btn-neutral" onclick="saveSurvey()" style="width:100%; margin-top:24px;">Next Round ‚Üí</button>
                   </div>`;

            app.innerHTML = `
                <div class="header" style="justify-content:center; border:none; margin-bottom:0; background:transparent; box-shadow:none;"><h2>Round Result</h2></div>
                <div class="balance-container">
                    <div class="balance-label">Current Balance</div>
                    <div class="balance-val">$${state.balance.toFixed(2)}</div>
                    <div class="pnl-badge" style="background:${badgeColor}">${txtBadge}</div>
                </div>
                <p style="text-align:center; color:var(--text-secondary); margin-bottom:24px; font-size:16px;">
                    Market moved: <b>${SCENARIOS[state.round].outcome}</b> by ${SCENARIOS[state.round].change_pct}%
                </p>
                <div class="chart-container"><img src="assets/${state.round}_result.png" class="chart-img" onerror="this.src='assets/${state.round}_result.PNG'"></div>
                ${footer}
            `;
            if(state.round !== 12) {
                setTimeout(() => {
                    updateBubble('q1', 'b-q1');
                    updateBubble('q2', 'b-q2', '', '%');
                    updateBubble('q3', 'b-q3', '', '%');
                }, 50);
            }
        }

        // --- 7. FINAL REFLECTION (POST-SURVEY: 4 MIRROR QUESTIONS) ---
        else if (state.step === 'final_feedback') {
            app.innerHTML = `
                <h1>Final Evaluation</h1>
                <p style="margin-bottom:30px; font-size:16px;">You have completed all 15 rounds. Based on the experience you just had, please answer the following questions regarding your future decisions.</p>
                
                <div class="slider-group">
                    <label class="slider-label">How much did your previous trading experience actually help you in this specific simulation?</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-post0">4</div>
                        <input type="range" id="post0" min="1" max="7" value="4" oninput="updateBubble('post0', 'b-post0')">
                    </div>
                    <div class="range-labels"><span>1 (Not at all)</span><span>7 (Extremely)</span></div>
                </div>

                <div class="slider-group">
                    <label class="slider-label">In the FUTURE, I still believe algorithms are generally more objective and accurate than human traders.</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-post1">4</div>
                        <input type="range" id="post1" min="1" max="7" value="4" oninput="updateBubble('post1', 'b-post1')">
                    </div>
                    <div class="range-labels"><span>1 (Strongly Disagree)</span><span>7 (Strongly Agree)</span></div>
                </div>

                <div class="slider-group">
                    <label class="slider-label">In future trading decisions, I will prioritize my own intuition and analysis over data signals.</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-post2">4</div>
                        <input type="range" id="post2" min="1" max="7" value="4" oninput="updateBubble('post2', 'b-post2')">
                    </div>
                    <div class="range-labels"><span>1 (Strongly Disagree)</span><span>7 (Strongly Agree)</span></div>
                </div>

                <div class="slider-group">
                    <label class="slider-label">Would you recommend or use a similar algorithmic advisor for REAL money investments in the future?</label>
                    <div class="range-wrapper">
                        <div class="bubble" id="b-post3">4</div>
                        <input type="range" id="post3" min="1" max="7" value="4" oninput="updateBubble('post3', 'b-post3')">
                    </div>
                    <div class="range-labels"><span>1 (Definitely Not)</span><span>7 (Definitely Yes)</span></div>
                </div>

                <div class="slider-group">
                    <label class="slider-label">Your Feedback (Optional): Did you notice any specific patterns or have thoughts on the advisor?</label>
                    <textarea id="final_comm" style="width:100%; height:100px; padding:16px; border-radius:12px; border:1px solid var(--color-ui); font-family:inherit; box-sizing:border-box; resize:vertical; font-size:15px;" placeholder="Type your thoughts here..."></textarea>
                </div>
                
                <div class="btn-row"><button class="btn-neutral" onclick="submitFinalData()">Submit & Reveal Truth</button></div>
            `;
            setTimeout(() => {
                ["post0", "post1", "post2", "post3"].forEach(id => updateBubble(id, 'b-'+id));
            }, 50);
        }

        // --- 8. DEBRIEF ---
        else if (state.step === 'debrief') {
            app.innerHTML = `
                <div style="text-align:center; padding-top:40px;">
                    <h1 style="margin-bottom:16px;">The Truth & Thank You</h1>
                    
                    <div class="debrief-box">
                        <h3 style="color:#1E40AF; margin-top:0; font-weight:800;">Important Research Disclosure:</h3>
                        <p>To ensure the scientific integrity of this study, we must now disclose that the <strong>Algorithmic Advisor was pre-programmed to deliver randomized signals with a fixed 50/50 accuracy rate.</strong></p>
                        <p>Our goal was not to test the algorithm, but to observe YOU ‚Äî how a human decision-maker calibrates trust and manages the Responsibility Gap when interacting with AI.</p>
                    </div>
                    
                    <h2 style="color:var(--color-long); margin-bottom:16px;">Data Saved Successfully!</h2>
                    
                    <div style="background:#F3F4F6; padding:20px; border-radius:12px; margin-top:30px; border:1px dashed #9CA3AF;">
                        <p style="margin:0; font-size:14px; color:#374151; font-weight:600;">Prolific Completion Code:</p>
                        <div style="font-size:28px; font-weight:800; color:#111; letter-spacing:2px; margin:10px 0;">[C7FGKQPP]</div>
                        <p style="margin:0; font-size:12px; color:#6B7280;">(Please copy this code if not redirected automatically)</p>
                    </div>

                    <p style="color:var(--text-secondary); margin-top:30px;">You may now close this window.</p>
                </div>
            `;
        }
    }

    // --- LOGIC ---
    function startTimer() {
        if(state.timer) clearInterval(state.timer);
        state.timeLeft = 30;
        state.timer = setInterval(() => {
            state.timeLeft--;
            const el = document.getElementById('timer');
            if(el) {
                el.innerText = `${state.timeLeft}s`;
                if(state.timeLeft <= 10) el.style.color = 'var(--color-short)';
            }
            if(state.timeLeft<=0) { clearInterval(state.timer); if(el) el.innerText="TIME!"; }
        }, 1000);
    }

    function commit(dir) {
        clearInterval(state.timer);
        state.roundData = {
            timestamp: new Date().toISOString(),
            participant_id: PID,
            round: state.round,
            ticker: SCENARIOS[state.round].ticker,
            initial_choice: dir,
            initial_wager: +document.getElementById('wager').value
        };
        state.step = 'decision'; render();
    }

    function finalize(choice) {
        const skip = choice === 'SKIP';
        const w = skip ? 0 : +document.getElementById('wager2').value;
        const sc = SCENARIOS[state.round];
        const pnl = skip ? 0 : (w * (sc.change_pct/100) * (choice===sc.outcome ? 1 : -1));
        
        state.balance += pnl;
        state.roundData = { ...state.roundData, final_choice: choice, final_wager: w, pnl: pnl, balance: state.balance };
        state.step = 'result'; render();
    }

    function saveSurvey() {
        state.roundData.regret = document.getElementById('q1').value;
        state.roundData.responsibility = document.getElementById('q2').value;
        state.roundData.influence = document.getElementById('q3').value;
        next();
    }

    function next() {
        state.history.push({...state.roundData});
        if (state.round >= MAX_ROUNDS) {
            state.step = 'final_feedback';
            render();
        } else {
            state.round++;
            state.step = 'initial';
            render();
        }
    }

    function savePreSurveyAndStart() {
        state.surveyAnswers = {
            survey_dep: document.getElementById('f1').value,
            survey_int: document.getElementById('f2').value,
            survey_del: document.getElementById('f3').value,
            survey_fut: document.getElementById('f4').value
        };
        state.step = 'initial'; 
        render();
    }

    function submitFinalData() {
        const finalComments = document.getElementById('final_comm').value;
        const postExp = document.getElementById('post0').value;
        const postTrust = document.getElementById('post1').value;
        const postIndep = document.getElementById('post2').value;
        const postRealUse = document.getElementById('post3').value;
        
        const finalData = state.history.map(row => ({
            ...row, 
            survey_dep: state.surveyAnswers.survey_dep,
            survey_int: state.surveyAnswers.survey_int,
            survey_del: state.surveyAnswers.survey_del,
            survey_fut: state.surveyAnswers.survey_fut,
            post_exp: postExp,
            post_trust: postTrust,
            post_independence: postIndep,
            post_real_use: postRealUse,
            comments: finalComments
        }));

        document.getElementById('loader').style.display = 'block';
        
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(finalData)
        }).then(() => {
            document.getElementById('loader').style.display = 'none';
            state.step = 'debrief';
            render();
        }).catch(err => {
            alert("Warning: Connection issue.");
            console.error(err);
            document.getElementById('loader').style.display = 'none';
        });
    }

    render();
</script>
</body>
</html>